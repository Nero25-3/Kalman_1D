name: Build, Test & Lint (CMake)

on:
  pull_request:
  push:
    branches: [main, develop]

jobs:

  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source
        uses: actions/checkout@v3
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake g++ libyaml-cpp-dev clang-format clang-tidy
      - name: Install GoogleTest
        run: |
          git clone https://github.com/google/googletest.git
          cd googletest && mkdir build && cd build
          cmake .. && make
          sudo make install
          cd ../../
      - name: Configure (CMake)
        run: |
          mkdir build
          cd build
          cmake ..
      - name: Build
        run: |
          cd build
          make -j$(nproc)

  test:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout source
        uses: actions/checkout@v3
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake g++ libyaml-cpp-dev
      - name: Install GoogleTest
        run: |
          git clone https://github.com/google/googletest.git
          cd googletest && mkdir build && cd build
          cmake .. && make
          sudo make install
          cd ../../
      - name: Run tests
        run: |
          cd build
          echo "N: 10" > config.yaml
          echo "dt: 0.1" >> config.yaml
          echo "velocity: 1.0" >> config.yaml
          echo "noise: 0.2" >> config.yaml
          echo "initial_uncertainty: 1.0" >> config.yaml
          echo "process_var: 0.03" >> config.yaml
          echo "outfile: filtered.csv" >> config.yaml
          echo "loglevel: 1" >> config.yaml
          echo "logfile: kalman.log" >> config.yaml
          echo "log_max_size_mb: 1" >> config.yaml
          echo "log_rotate_count: 2" >> config.yaml
          ./kalman1d_tests
          ./kalman1d_demo config.yaml

  lint:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout source
        uses: actions/checkout@v3
      - name: Install clang-format
        run: sudo apt-get update && sudo apt-get install -y clang-format
      - name: Lint source code (clang-format)
        run: |
          if ! clang-format --dry-run --Werror $(find src/ -name '*.cpp' -or -name '*.hpp'); then
            echo "Code formatting failed! Run clang-format locally."
            exit 1
          fi
      - name: Static analysis (clang-tidy)
        run: |
          sudo apt-get install -y clang-tidy
          clang-tidy src/*.cpp -- -I./src -I/usr/include -I/usr/include/yaml-cpp || { echo "Static analysis failed. Fix errors!"; exit 1; }


  plot:
    runs-on: ubuntu-latest
    needs: test
    steps:
      - name: Checkout source
        uses: actions/checkout@v3
      - name: Install Python and matplotlib
        run: |
          sudo apt-get update
          sudo apt-get install -y python3 python3-pip
          pip3 install matplotlib pandas
      - name: Plot results if CSV exists
        run: |
          cd build
          if [ -f filtered.csv ]; then
            python ../scripts/plot_kalman.py
          else
            echo "No filtered.csv, skipping plot."
          fi
      - name: Upload plot
        uses: actions/upload-artifact@v3
        with:
          name: kalman_plot
          path: build/kalman_results.png